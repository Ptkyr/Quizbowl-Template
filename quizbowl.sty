%% A template for writing Quizbowl packets
%% Author: https://github.com/Ptkyr/
%% To use, place quizbowl.sty in the same folder and either: 
%%  * \usepackage{quizbowl} if you have no powers
%%  * \usepackage[powers = true]{quizbowl} if you have powers
%%    and denote powers with \powmark

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{quizbowl}

\RequirePackage[utf8]{inputenc}
\RequirePackage[margin=1in]{geometry}
\RequirePackage{kvoptions} % toggle globals
\RequirePackage{amsthm} % numbering
\RequirePackage{tikz} % i need \foreach, okay?
\RequirePackage{etoolbox} % toggles
\RequirePackage{fancyhdr} % header
\RequirePackage{xparse} % if/else for optional
\RequirePackage{titlesec} % section stuff
\RequirePackage{enumitem} % enumerate (tossuplist)
\RequirePackage{xcolor} % colors
\RequirePackage{contour} % setup for underlining
\RequirePackage[normalem]{ulem} % better underlining, soul breaks?
\RequirePackage{times} % tnr masterrace

%%--------------Formatting----------------
\SetupKeyvalOptions{
 family=ptkyr,
 prefix=ptkyr@
}

\DeclareBoolOption{powers} % defaults to false

\ProcessKeyvalOptions*

\pagestyle{fancy}
\fancyhead[C]{Quizbowl Template}
\lhead{}
\rhead{}
\fancyfoot{}

\titleformat{\section}%
  [hang]% <shape>
  {\bfseries}% <format>
  {}% <label>
  {0pt}% <sep>
  {}% <before code>

% https://alexwlchan.net/2017/10/latex-underlines/
\renewcommand{\ULdepth}{1.8pt}
\renewcommand{\ULthickness}{0.1pt}
\contourlength{0.8pt}
\newcommand{\ul}[1]{%
  \uline{\phantom{#1}}%
  \llap{\contour{white}{#1}}%
}

\definecolor{pguidecol}{HTML}{565656} % pronunciation guide colour

\newtheoremstyle{tu}%  % Name
  {0pt}%               % Space above
  {0pt}%               % Space below
  {\ifptkyr@powers\bfseries\fi}%                  % Body font (empty for upright)
  {}%                  % Indent amount
  {}%                  % Theorem head font
  {.}%                 % Post-number delimiter        
  {0.5em}%             % Space after theorem head
  {}%                  % Theorem head spec
\theoremstyle{tu}
\newtheorem{tossupi}{}
\newtheorem{bonusi}{}

% https://tex.stackexchange.com/questions/234119/keep-theorem-content-on-the-same-page
\newcommand{\blocktheorem}[1]{%
  \csletcs{old#1}{#1}% Store \begin
  \csletcs{endold#1}{end#1}% Store \end
  \RenewDocumentEnvironment{#1}{o}
    {\par\addvspace{1.5ex}
     \noindent\begin{minipage}{\textwidth}
     \IfNoValueTF{##1}
       {\csuse{old#1}}
       {\csuse{old#1}[##1]}}
    {\csuse{endold#1}
     \end{minipage}
     \par\addvspace{1.5ex}}
}
\raggedbottom

\blocktheorem{tossupi}
\blocktheorem{bonusi}

% Literally all Yusuf, shoutouts to Yusuf
\ExplSyntaxOn
\clist_new:N \l_alt_clist
\NewDocumentCommand{\alt}{O{\space or \space}m}{
   \clist_set:Nn \l_alt_clist {#2}
   \foreach \x [count=\i] in \l_alt_clist 
    {\need{\x} \int_compare:nNnF {\i} = {\clist_count:N \l_alt_clist} {#1} }
}

\clist_new:N \l_promptll_clist
\NewDocumentCommand{\promptll}{O{\space or \space}m}{
   \clist_set:Nn \l_promptll_clist {#2}
   \foreach \x [count=\i] in \l_promptll_clist 
    {\uline{\x}  \int_compare:nNnF {\i} = {\clist_count:N \l_promptll_clist} {#1} }
}

\clist_new:N \l_rejectll_clist
\NewDocumentCommand{\rejectll}{O{\space or \space}m}{
   \clist_set:Nn \l_rejectll_clist {#2}
   \foreach \x [count=\i] in \l_rejectll_clist 
    {\quotes{\x}  \int_compare:nNnF {\i} = {\clist_count:N \l_rejectll_clist} {#1} }
}
\ExplSyntaxOff
%%----------------------------------------

%%-----------Quizbowl Commands------------
\newenvironment{tossup}
{\begin{tossupi}}
{\end{tossupi}
\bigbreak}
\newenvironment{bonus}
{\begin{bonusi}\normalfont}
{\end{bonusi}
\bigbreak}

\newcommand{\powmark}{(*)\space\normalfont}
\newcommand{\ftp}{For 10 points,\space}
\newcommand{\ftpe}{For 10 points each:}
\newcommand{\vague}{\emph{Description acceptable.\space}}
\newcommand{\needmorethan}{prompt on answers that only mention\space}
\newcommand{\need}[1]{\ul{\textbf{#1}}} % Necessary part of answer line
\newcommand{\pguide}[1]{\textcolor{pguidecol}{(\small``#1")}} % pronunciation guide
\newcommand{\quotes}[1]{``#1"} % easier quotations
\newcommand{\work}[1]{\emph{#1}}
\NewDocumentCommand{\ansf}{m}{\par \noindent ANSWER: #1}
\NewDocumentCommand{\ans}{m}{\par \noindent ANSWER: \need{#1}}
\NewDocumentCommand{\also}{m}{or \alt{#1}}
\newcommand{\accept}[1]{accept\space#1}
\NewDocumentCommand{\prompt}{m}{prompt on \promptll{#1}}
\NewDocumentCommand{\reject}{m}{reject \rejectll{#1}}
\newcommand{\cluenote}[1]{(#1)}
\newcommand{\category}[1]{\par\noindent \textless #1\textgreater}
\newcommand{\clueauthor}[1]{\space[#1]}
\NewDocumentCommand{\bonusclue}{om}{% options are [e|m|h]
\par \noindent%
\IfNoValueTF{#1}
    {#2}
    {[10#1]\space #2}
}
%%----------------------------------------
